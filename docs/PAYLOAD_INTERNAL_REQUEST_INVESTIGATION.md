# Payload 3.x Internal Request Mechanism Investigation

**Date:** December 31, 2025  
**Status:** ðŸ” INVESTIGATION COMPLETE  
**Related Issue:** API Route Not Found - "/api/" Error

## Executive Summary

Investigation into Payload CMS 3.x's internal request mechanism reveals that the admin handler uses `handleEndpoints` which processes requests server-side, but the error "Route not found '/api/'" suggests Payload is making an internal HTTP request that fails before reaching our route handler.

## Key Findings

### 1. Admin Route Handler Flow

**File:** `app/(payload)/admin/[[...segments]]/route.ts`

The admin route handler:
1. Receives request for `/admin`
2. Extracts slug (empty array for `/admin`)
3. Calls `REST_GET(configPromise)` handler
4. Handler calls `handleEndpoints` from Payload

**Code Flow:**
```typescript
export const GET = adminHandler(REST_GET(configPromise));
â†“
REST_GET from @payloadcms/next/routes
â†“
handleEndpoints({
  config,
  path: formatAdminURL({
    apiRoute: awaitedConfig.routes.api,  // '/api'
    path: awaitedParams ? `/${awaitedParams.slug.join('/')}` : undefined
  }),
  request
})
```

### 2. formatAdminURL Function Behavior

**Location:** `node_modules/payload/dist/utilities/formatAdminURL.js`

**Implementation:**
```javascript
export const formatAdminURL = (args) => {
  const { adminRoute, apiRoute, path = '', relative = false, serverURL } = args;
  const routePath = adminRoute || apiRoute;
  const segments = [
    routePath && routePath !== '/' && routePath,
    path && path
  ].filter(Boolean);
  const pathname = segments.join('') || '/';
  const pathnameWithBase = (basePath + pathname).replace(/\/$/, '') || '/';
  // ...
}
```

**Test Results:**
- `formatAdminURL({apiRoute: '/api', path: undefined})` â†’ `/api` âœ…
- `formatAdminURL({apiRoute: '/api', path: ''})` â†’ `/api` âœ…

**Conclusion:** `formatAdminURL` correctly constructs `/api` (no trailing slash) when path is undefined or empty.

### 3. handleEndpoints Function

**Location:** `node_modules/payload/dist/utilities/handleEndpoints.d.ts`

**Purpose:** Attaches Payload REST API to any backend framework using Fetch Request/Response (Next.js App Router, Remix, Bun, Hono).

**Key Insight:** `handleEndpoints` processes requests **server-side** and does NOT make HTTP requests. It directly processes the request object.

### 4. The Actual Problem

**Server Logs Show:**
```
[Payload Admin] GET /admin - Handler invoked
[Payload Admin] GET /admin - Slug: []
[Payload Admin] GET /admin - Calling Payload handler
[Payload Admin] GET /admin - Response status: 404
[Payload Admin] GET /admin - 404 response body: {"message":"Route not found \"/api/\""}
```

**Critical Observation:**
- âœ… Admin route handler is invoked
- âœ… Slug extraction works (empty array)
- âœ… Payload handler is called
- âŒ **No `[Payload API]` logs appear** - This means no HTTP request is made to `/api/`
- âŒ Payload returns 404 with "Route not found '/api/'"

**Conclusion:** The error is coming from **inside Payload's `handleEndpoints` function**, not from an HTTP request.

### 5. How Payload Admin UI Works

Based on investigation:

1. **Admin Route Handler** (`app/(payload)/admin/[[...segments]]/route.ts`):
   - Receives request for `/admin`
   - Calls Payload's `REST_GET` handler
   - Handler calls `handleEndpoints` with path `/api` (from `formatAdminURL`)

2. **handleEndpoints Processing**:
   - Processes the request server-side
   - Does NOT make HTTP requests
   - Directly handles the request using Payload's internal routing

3. **Admin UI Rendering**:
   - Payload's admin UI is server-side rendered
   - The admin UI HTML includes client-side JavaScript
   - Client-side JavaScript makes requests to `/api/config`, `/api/collections`, etc.

### 6. Root Cause Identified âœ…

**Found in `node_modules/payload/dist/utilities/handleEndpoints.js`:**

```javascript
const notFoundResponse = (req, pathname) => {
    return Response.json({
        message: `Route not found "${pathname ?? new URL(req.url).pathname}"`
    }, {
        status: httpStatus.NOT_FOUND
    });
};
```

**The Error Source:**
- The error `{"message":"Route not found \"/api/\""}` is generated by Payload's `notFoundResponse` function
- This function is called when `handleEndpoints` cannot match the provided `path` against Payload's internal route registry
- The `pathname` parameter contains `/api/` (with trailing slash)

**Why `/api/` Instead of `/api`?**

Looking at the REST route handler code:
```javascript
path: formatAdminURL({
  apiRoute: awaitedConfig.routes.api,  // '/api'
  path: awaitedParams ? `/${awaitedParams.slug.join('/')}` : undefined
})
```

When `awaitedParams.slug` is empty (for `/admin` route), `path` becomes `undefined`. However, `formatAdminURL` should handle this correctly and return `/api` (no trailing slash).

**The Real Issue:**
The problem is that `handleEndpoints` receives a `path` parameter, but it also uses `new URL(req.url).pathname` from the original request. When the admin handler calls `handleEndpoints`, it's passing `path: '/api'`, but the original request URL might be `/admin`, and Payload might be constructing the path from the request URL instead of using the provided `path` parameter.

### 7. Investigation of handleEndpoints

**What We Know:**
- `handleEndpoints` receives `path: '/api'` (from `formatAdminURL`)
- It processes requests server-side (no HTTP)
- It returns 404 with "Route not found '/api/'"

**What We Don't Know:**
- How `handleEndpoints` processes the path internally
- Why it's looking for `/api/` instead of `/api`
- Whether it's adding a trailing slash internally

### 8. Possible Solutions

#### Solution A: Check Payload's Route Registry

Payload might be registering routes with trailing slashes. Check if:
- Routes are registered as `/api/` instead of `/api`
- Payload's route matching is adding trailing slashes

#### Solution B: Verify routes Configuration

Ensure `routes.api` is exactly `/api` (not `/api/`):
```typescript
routes: {
  api: '/api',  // âœ… Correct
  admin: '/admin',
}
```

#### Solution C: Check handleEndpoints Path Processing

Payload's `handleEndpoints` might be normalizing paths and adding trailing slashes. This could be a bug or expected behavior in Payload 3.x.

#### Solution D: Admin UI Client-Side Requests

The admin UI's client-side JavaScript might be making requests to `/api/` (with trailing slash). These would be separate from the server-side `handleEndpoints` call.

## Next Steps

1. **Check Payload Source Code**: Examine `handleEndpoints` implementation to see how it processes paths
2. **Check Admin UI Client Code**: Verify what URLs the admin UI's client-side JavaScript uses
3. **Test with Different Routes**: Try changing `routes.api` to see if behavior changes
4. **Check Payload Version**: Verify if this is a known issue in Payload 3.69.0
5. **Check Payload GitHub Issues**: Search for similar issues with "/api/" and trailing slashes

## Related Files

- `app/(payload)/admin/[[...segments]]/route.ts` - Admin route handler
- `app/(payload)/api/[[...segments]]/route.ts` - API route handler
- `payload.config.ts` - Payload configuration
- `node_modules/@payloadcms/next/dist/routes/rest/index.js` - REST route handler
- `node_modules/payload/dist/utilities/formatAdminURL.js` - URL formatting function
- `node_modules/payload/dist/utilities/handleEndpoints.d.ts` - Endpoint handler

## References

- Payload CMS Documentation: Internal Request Mechanism
- Payload CMS GitHub: Issues related to "/api/" and trailing slashes
- Payload CMS 3.x Migration Guide: Route handling changes

